// ==UserScript==
// @name	github-etab
// @namespace	https://github.com/hax/etab
// @version	0.6
// @description	Support elastic tabstops for github.com
// @match	https://github.com/*
// @updateURL	https://raw.githubusercontent.com/hax/etab/master/dist/github.meta.js
// @downloadURL	https://raw.githubusercontent.com/hax/etab/master/dist/github.user.js
// @copyright	2014, Hax
// ==/UserScript==
!function(t){"use strict";function e(t){var e=t||{};this.settings={tabTagName:e.tabTagName||"span",tabClassName:e.tabClassName||"tab-char",indentClassName:e.indentClassName||"ident",tabIndentExtraSpace:8,tabSpaceMinWidth:e.tabSpaceMinWidth||"1em",styleId:e.styleId||"etab-style",styleRules:e.styleRules||[]}}function n(){for(var e=/^["'([{“‘]+$/,n=t.querySelectorAll(".highlight .p"),a=0;a<n.length;a++)e.test(n[a].textContent)&&n[a].classList.add("open");for(var s=t.querySelectorAll(".blob-wrapper"),a=0;a<s.length;a++)i.processLines(s[a].querySelectorAll(".blob-code"))}var a="	",s=3;e.prototype._addStyle=function(t){if(!t.getElementById(this.settings.styleId)){var e=t.createElement("style");e.id=this.settings.styleId,t.body.appendChild(e);var n=this.settings.tabTagName+"."+this.settings.tabClassName;e.sheet.insertRule(n+"{ display: inline-block; margin-right: "+this.settings.tabSpaceMinWidth+" }",0),this.settings.styleRules.forEach(function(t,n){e.sheet.insertRule(t,n+1)})}},e.prototype.processLines=function(t){function e(t,i){if(!(t>=s.length)){if(i>=s[t].length)return e(t+1,0);var r=a(t,i);if(r.aligned)return e(t,i+1);n(r),setTimeout(function(){e(t,i+1)})}}function n(t){var e=t.map(function(t){var e=t.getBoundingClientRect().right;return t.classList.contains(o.indentClassName)&&(e+=o.tabIndentExtraSpace),e}),n=Math.max.apply(null,e);t.forEach(function(t){t.style.width=n-t.getBoundingClientRect().right+"px"}),t.aligned=!0}function a(t,e){var n=[];if(t>=0&&t<s.length&&e>=0&&e<s[t].length){var a=l[t][e];if(a)return a;for(var i=t-1,r=t+1;i>=0&&e<s[i].length;)i--;for(;r<s.length&&e<s[r].length;)r++;for(var o=i+1;r>o;o++)n.push(s[o][e]),l[o][e]=n}return n}t.length&&this._addStyle(t[0].ownerDocument);for(var s=[],i=0,r=t.length;r>i;i++)this._wrapAllTabs(t[i]),s[i]=t[i].querySelectorAll(this.settings.tabTagName+"."+this.settings.tabClassName);var l=s.map(function(t){return new Array(t.length)}),o=this.settings;e(0,0)},e.prototype._wrapAllTabs=function(t,e){if(void 0===e&&(e=!0),t.nodeType===s){for(var n;(n=t.wholeText.indexOf(a))>=0;){e&&n>0&&(e=!1);var i=t.splitText(n);t=i.splitText(1),this._wrapTab(i,e)}e&&t.wholeText.length>0&&(e=!1)}else if(!this._isTab(t))for(var r=t.firstChild;r;){var l=r.nextSibling;e=this._wrapAllTabs(r,e),r=l}return e},e.prototype._wrapTab=function(t,e){var n=t.ownerDocument.createElement(this.settings.tabTagName);return n.classList.add(this.settings.tabClassName),e&&n.classList.add(this.settings.indentClassName),t.parentNode.replaceChild(n,t),n.appendChild(t),n},e.prototype._isTab=function(t){return t.nodeName===this.settings.tabTagName&&t.classList.contains(this.settings.tabClassName)},e.prototype._wrapTabColumns=function(){};var i=new e({styleRules:[".blob-code { font-family: 'Input Serif Narrow', 'Georgia', serif; font-size: 1.167em; }",".highlight .p { color: #bbb; font-weight: lighter; }",".highlight span.tab-char + .open.p { position: absolute; transform: translateX(-100%); }"]});$(t).ready(n).on("pjax:success",n)}(document);